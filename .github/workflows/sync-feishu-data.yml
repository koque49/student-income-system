name: åŒæ­¥é£žä¹¦æ•°æ®

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´8ç‚¹
  workflow_dispatch:     # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write    # é‡è¦ï¼šå†™å…¥æƒé™
      
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: åˆ›å»ºæ•°æ®ç›®å½•
        run: |
          mkdir -p data
          echo "âœ… æ•°æ®ç›®å½•åˆ›å»ºå®Œæˆ"
          
      - name: èŽ·å–é£žä¹¦ä»¤ç‰Œ
        id: token
        run: |
          echo "ðŸ” èŽ·å–é£žä¹¦è®¿é—®ä»¤ç‰Œ..."
          
          response=$(curl -s -w "HTTPSTATUS:%{http_code}" -X POST \
            "https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal" \
            -H "Content-Type: application/json" \
            -d '{"app_id":"cli_a84a4855cb36500b","app_secret":"NJxiXZAZLLZcVJ2Mh9dzmb0W8vioZNRM"}')
          
          http_code=$(echo $response | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          body=$(echo $response | sed -e 's/HTTPSTATUS\:.*//g')
          
          echo "HTTPçŠ¶æ€ç : $http_code"
          echo "å“åº”å†…å®¹: $body"
          
          if [ $http_code -ne 200 ]; then
            echo "âŒ HTTPè¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : $http_code"
            exit 1
          fi
          
          token=$(echo $body | grep -o '"tenant_access_token":"[^"]*' | cut -d'"' -f4)
          
          if [ -z "$token" ]; then
            echo "âŒ æ— æ³•æå–è®¿é—®ä»¤ç‰Œ"
            echo "å“åº”: $body"
            exit 1
          fi
          
          echo "âœ… ä»¤ç‰ŒèŽ·å–æˆåŠŸ"
          echo "token=$token" >> $GITHUB_OUTPUT
          
      - name: èŽ·å–è¡¨æ ¼æ•°æ®
        run: |
          echo "ðŸ“Š èŽ·å–é£žä¹¦è¡¨æ ¼æ•°æ®..."
          
          response=$(curl -s -w "HTTPSTATUS:%{http_code}" -X GET \
            "https://open.feishu.cn/open-apis/sheets/v4/spreadsheets/Je42sildNh5sJAtktSlc0azDnsb/values/R6PBsw!A1:E1000" \
            -H "Authorization: Bearer ${{ steps.token.outputs.token }}")
          
          http_code=$(echo $response | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          body=$(echo $response | sed -e 's/HTTPSTATUS\:.*//g')
          
          echo "æ•°æ®APIçŠ¶æ€ç : $http_code"
          
          if [ $http_code -ne 200 ]; then
            echo "âŒ æ•°æ®èŽ·å–å¤±è´¥ï¼ŒçŠ¶æ€ç : $http_code"
            echo "å“åº”: $body"
            exit 1
          fi
          
          # ä¿å­˜æ•°æ®
          echo $body > data/feishu-response.json
          
          # æ£€æŸ¥æ•°æ®æ ¼å¼
          code=$(echo $body | grep -o '"code":[^,]*' | cut -d':' -f2)
          
          if [ "$code" != "0" ]; then
            echo "âŒ é£žä¹¦APIè¿”å›žé”™è¯¯"
            echo "å“åº”: $body"
            exit 1
          fi
          
          # æå–valuesæ•°ç»„
          echo $body | sed 's/.*"values":\[\([^]]*\)\].*/[\1]/' > data/income-data.json
          
          # åˆ›å»ºåŒæ­¥æŠ¥å‘Š
          cat > data/sync-report.json << EOF
          {
            "lastSync": "$(date '+%Y-%m-%d %H:%M:%S')",
            "status": "success",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
          
          echo "âœ… æ•°æ®èŽ·å–æˆåŠŸ"
          
      - name: æäº¤æ•°æ®
        run: |
          echo "ðŸ’¾ æäº¤æ•°æ®æ›´æ–°..."
          
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          
          git add data/
          
          if git diff --staged --quiet; then
            echo "ðŸ“Š æ•°æ®æ— å˜æ›´"
          else
            git commit -m "ðŸ”„ è‡ªåŠ¨åŒæ­¥æ•°æ® $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… æ•°æ®å·²æ›´æ–°"
          fi
