name: è‡ªåŠ¨åŒæ­¥é£ä¹¦æ”¶ç›Šæ•°æ®

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š8ç‚¹å’Œæ™šä¸Š8ç‚¹åŒæ­¥ï¼ˆUTCæ—¶é—´ï¼ŒåŒ—äº¬æ—¶é—´+8ï¼‰
    - cron: '0 0 * * *'   # åŒ—äº¬æ—¶é—´æ—©ä¸Š8ç‚¹
    - cron: '0 12 * * *'  # åŒ—äº¬æ—¶é—´æ™šä¸Š8ç‚¹
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]  # ä»£ç æ›´æ–°æ—¶ä¹Ÿè§¦å‘

jobs:
  sync-data:
    runs-on: ubuntu-latest
    name: åŒæ­¥é£ä¹¦æ•°æ®å¹¶éƒ¨ç½²
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: åˆ›å»ºæ•°æ®ç›®å½•
        run: |
          mkdir -p data
          echo "æ•°æ®ç›®å½•åˆ›å»ºå®Œæˆ"

      - name: è·å–é£ä¹¦è®¿é—®ä»¤ç‰Œ
        id: get-token
        run: |
          echo "æ­£åœ¨è·å–é£ä¹¦è®¿é—®ä»¤ç‰Œ..."
          
          RESPONSE=$(curl -s -X POST "https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal" \
            -H "Content-Type: application/json" \
            -d '{
              "app_id": "cli_a84a4855cb36500b",
              "app_secret": "NJxiXZAZLLZcVJ2Mh9dzmb0W8vioZNRM"
            }')
          
          echo "ä»¤ç‰Œå“åº”: $RESPONSE"
          
          # æå–token
          TOKEN=$(echo $RESPONSE | jq -r '.tenant_access_token // empty')
          
          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "âŒ è·å–è®¿é—®ä»¤ç‰Œå¤±è´¥"
            echo $RESPONSE | jq '.'
            exit 1
          fi
          
          echo "âœ… è®¿é—®ä»¤ç‰Œè·å–æˆåŠŸ"
          echo "FEISHU_TOKEN=$TOKEN" >> $GITHUB_OUTPUT

      - name: åŒæ­¥é£ä¹¦è¡¨æ ¼æ•°æ®
        run: |
          echo "æ­£åœ¨åŒæ­¥é£ä¹¦è¡¨æ ¼æ•°æ®..."
          
          # è·å–å½“å‰æ—¶é—´
          SYNC_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          echo "åŒæ­¥æ—¶é—´: $SYNC_TIME"
          
          # è°ƒç”¨é£ä¹¦APIè·å–æ•°æ®
          RESPONSE=$(curl -s -X GET \
            "https://open.feishu.cn/open-apis/sheets/v4/spreadsheets/Je42sildNh5sJAtktSlc0azDnsb/values/R6PBsw!A1:E1000" \
            -H "Authorization: Bearer ${{ steps.get-token.outputs.FEISHU_TOKEN }}" \
            -H "Content-Type: application/json")
          
          echo "æ•°æ®å“åº”çŠ¶æ€: $(echo $RESPONSE | jq -r '.code // "unknown"')"
          
          # æ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸ
          CODE=$(echo $RESPONSE | jq -r '.code // -1')
          if [ "$CODE" != "0" ]; then
            echo "âŒ è·å–è¡¨æ ¼æ•°æ®å¤±è´¥"
            echo $RESPONSE | jq '.'
            exit 1
          fi
          
          # ä¿å­˜å®Œæ•´å“åº”æ•°æ®
          echo $RESPONSE > data/feishu-raw-response.json
          
          # æå–valuesæ•°æ®å¹¶ä¿å­˜
          echo $RESPONSE | jq '.data.values // []' > data/income-data.json
          
          # åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„å¤‡ä»½
          cp data/income-data.json "data/backup-$(date '+%Y%m%d-%H%M%S').json"
          
          # æ£€æŸ¥æ•°æ®è¡Œæ•°
          ROWS=$(echo $RESPONSE | jq '.data.values | length // 0')
          echo "âœ… æˆåŠŸè·å– $ROWS è¡Œæ•°æ®"
          
          # ç”ŸæˆåŒæ­¥æŠ¥å‘Š
          cat > data/sync-report.json << EOF
          {
            "lastSync": "$SYNC_TIME",
            "dataRows": $ROWS,
            "status": "success",
            "source": "feishu-sheets",
            "version": "$(date '+%Y%m%d%H%M%S')"
          }
          EOF
          
          echo "æ•°æ®åŒæ­¥å®Œæˆï¼"

      - name: è½¬æ¢ä¸ºCSVæ ¼å¼ï¼ˆå…¼å®¹æ€§ï¼‰
        run: |
          echo "è½¬æ¢æ•°æ®ä¸ºCSVæ ¼å¼..."
          
          # ä½¿ç”¨Node.jsè½¬æ¢JSONä¸ºCSV
          cat > convert-to-csv.js << 'EOF'
          const fs = require('fs');
          
          try {
            const data = JSON.parse(fs.readFileSync('data/income-data.json', 'utf8'));
            
            if (!Array.isArray(data) || data.length === 0) {
              console.log('æ— æ•°æ®éœ€è¦è½¬æ¢');
              process.exit(0);
            }
            
            // è½¬æ¢ä¸ºCSVæ ¼å¼
            const csvLines = data.map(row => {
              return Array.isArray(row) ? row.map(cell => 
                typeof cell === 'string' && cell.includes(',') 
                  ? `"${cell}"` 
                  : cell
              ).join(',') : '';
            });
            
            const csvContent = csvLines.join('\n');
            fs.writeFileSync('data/income-data.csv', csvContent);
            
            console.log(`âœ… CSVè½¬æ¢å®Œæˆï¼Œå…±${data.length}è¡Œæ•°æ®`);
          } catch (error) {
            console.error('CSVè½¬æ¢å¤±è´¥:', error.message);
            process.exit(1);
          }
          EOF
          
          node convert-to-csv.js

      - name: éªŒè¯æ•°æ®å®Œæ•´æ€§
        run: |
          echo "éªŒè¯æ•°æ®å®Œæ•´æ€§..."
          
          # æ£€æŸ¥JSONæ–‡ä»¶
          if [ ! -f "data/income-data.json" ]; then
            echo "âŒ JSONæ•°æ®æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ£€æŸ¥CSVæ–‡ä»¶
          if [ ! -f "data/income-data.csv" ]; then
            echo "âŒ CSVæ•°æ®æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          JSON_SIZE=$(stat -c%s "data/income-data.json")
          CSV_SIZE=$(stat -c%s "data/income-data.csv")
          
          echo "æ–‡ä»¶å¤§å°æ£€æŸ¥:"
          echo "  JSON: ${JSON_SIZE} bytes"
          echo "  CSV: ${CSV_SIZE} bytes"
          
          if [ "$JSON_SIZE" -lt 50 ]; then
            echo "âŒ JSONæ–‡ä»¶è¿‡å°ï¼Œå¯èƒ½æ•°æ®ä¸å®Œæ•´"
            exit 1
          fi
          
          echo "âœ… æ•°æ®å®Œæ•´æ€§éªŒè¯é€šè¿‡"

      - name: æäº¤æ›´æ–°çš„æ•°æ®
        run: |
          echo "æäº¤æ•°æ®æ›´æ–°..."
          
          # é…ç½®Git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          
          # æ·»åŠ æ‰€æœ‰æ•°æ®æ–‡ä»¶
          git add data/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --cached --quiet; then
            echo "ğŸ“Š æ•°æ®æ— å˜æ›´ï¼Œè·³è¿‡æäº¤"
          else
            # åˆ›å»ºæäº¤ä¿¡æ¯
            SYNC_TIME=$(date '+%Y-%m-%d %H:%M:%S')
            ROWS=$(jq 'length // 0' data/income-data.json 2>/dev/null || echo "0")
            
            git commit -m "ğŸ”„ è‡ªåŠ¨åŒæ­¥æ•°æ® | ${SYNC_TIME} | ${ROWS}è¡Œæ•°æ®" || {
              echo "æäº¤å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
            }
            
            # æ¨é€åˆ°ä»“åº“
            git push || {
              echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œå¯èƒ½æ˜¯å¹¶å‘é—®é¢˜"
              git pull --rebase
              git push
            }
            
            echo "âœ… æ•°æ®å·²æˆåŠŸæäº¤å¹¶æ¨é€"
          fi

      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        run: |
          echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -f convert-to-csv.js
          
          # åªä¿ç•™æœ€æ–°çš„5ä¸ªå¤‡ä»½æ–‡ä»¶
          cd data
          ls -t backup-*.json | tail -n +6 | xargs -r rm
          echo "âœ… æ¸…ç†å®Œæˆ"

      - name: åŒæ­¥çŠ¶æ€æ€»ç»“
        run: |
          echo "========== åŒæ­¥çŠ¶æ€æ€»ç»“ =========="
          echo "â° åŒæ­¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          if [ -f "data/income-data.json" ]; then
            ROWS=$(jq 'length // 0' data/income-data.json)
            echo "ğŸ“Š æ•°æ®è¡Œæ•°: $ROWS"
            echo "ğŸ“ æ–‡ä»¶å¤§å°: $(stat -c%s data/income-data.json) bytes"
          fi
          
          echo "ğŸ”— æ•°æ®æº: é£ä¹¦åœ¨çº¿è¡¨æ ¼"
          echo "âœ… åŒæ­¥çŠ¶æ€: æˆåŠŸå®Œæˆ"
          echo "================================="

      # å¦‚æœåŒæ­¥å¤±è´¥ï¼Œå‘é€é€šçŸ¥
      - name: åŒæ­¥å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ æ•°æ®åŒæ­¥å¤±è´¥ï¼"
          echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "è¯·æ£€æŸ¥é£ä¹¦APIæƒé™å’Œç½‘ç»œè¿æ¥"
